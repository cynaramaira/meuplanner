<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Gamificado ‚Ä¢ Rotina Compassiva</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#764ba2"/>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <!-- Tailwind CSS e Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados inspirados no exemplo */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .task-item, .config-item {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .task-item:hover, .config-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #a78bfa;
        }

        .task-checkbox:checked + .task-content {
            opacity: 0.6;
        }
        
        .task-checkbox:checked + .task-content .task-text {
            text-decoration: line-through;
        }
        
        .task-checkbox:checked + .task-content .task-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: bounce 0.6s ease;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }
        
        .progress-ring {
            transition: stroke-dasharray 0.8s ease;
        }
        
        .tab-active {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .streak-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
            to { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
        }
        
        .level-up {
            animation: levelUpPulse 1s ease-out;
        }
        
        @keyframes levelUpPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .agenda-event {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-5xl mx-auto glass-card rounded-3xl shadow-2xl p-4 sm:p-8 relative overflow-hidden">
        
        <!-- Cabe√ßalho com Level e Streak -->
        <header class="text-center mb-6 relative">
            <div class="flex justify-between items-start mb-3">
                <div class="streak-badge text-white px-3 py-1 rounded-full text-sm font-semibold">
                    üî• <span id="streak">0</span> dias
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                    üîÆ N√≠vel <span id="level">1</span>
                </div>
            </div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                Rotina Compassiva
            </h1>
            <p id="greeting" class="text-gray-600 text-sm">Carregando data... üåü</p>
        </header>

        <!-- Progresso Circular -->
        <div class="flex justify-center mb-6">
            <div class="relative w-24 h-24">
                <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                    <circle id="bar" cx="50" cy="50" r="40" stroke="url(#gradient)" stroke-width="8" 
                            fill="none" stroke-linecap="round" class="progress-ring"
                            stroke-dasharray="0 251.2" />
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#a78bfa"/>
                            <stop offset="100%" style="stop-color:#ec4899"/>
                        </linearGradient>
                    </defs>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="xp" class="text-lg font-bold text-gray-700">0 XP</span>
                </div>
            </div>
        </div>

        <!-- Abas de Navega√ß√£o -->
        <div class="flex justify-center mb-6 bg-gray-100 rounded-2xl p-1 max-w-lg mx-auto">
            <button data-tab="hoje" class="tab tab-active py-2 px-4 font-medium rounded-xl transition-all duration-300 flex-1 text-sm">
                üìÖ Hoje
            </button>
            <button data-tab="semana" class="tab py-2 px-4 font-medium text-gray-600 rounded-xl transition-all duration-300 flex-1 text-sm">
                üìä Semana
            </button>
             <button data-tab="agenda" class="tab py-2 px-4 font-medium text-gray-600 rounded-xl transition-all duration-300 flex-1 text-sm">
                üóìÔ∏è Agenda
            </button>
            <button data-tab="config" class="tab py-2 px-4 font-medium text-gray-600 rounded-xl transition-all duration-300 flex-1 text-sm">
                ‚öôÔ∏è Configurar
            </button>
        </div>

        <!-- Conte√∫do das Abas -->
        <main>
            <!-- Miss√µes de Hoje -->
            <section id="view-hoje" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h2 class="font-bold text-indigo-800">‚òÄÔ∏è Rituais da Manh√£</h2>
                    <div id="morning" class="space-y-3 mt-2"></div>
                </div>
                <div>
                    <h2 class="font-bold text-indigo-800">üíº Trabalho</h2>
                    <div id="work" class="space-y-3 mt-2"></div>
                </div>
                <div class="lg:col-span-2">
                    <h2 class="font-bold text-indigo-800">üè° Chegada em Casa & Bem-estar</h2>
                    <div id="home" class="space-y-3 mt-2"></div>
                </div>
            </section>

            <!-- Vis√£o da Semana -->
            <section id="view-semana" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- O conte√∫do da semana ser√° inserido aqui pelo JS -->
            </section>
            
            <!-- Agenda da Semana -->
            <section id="view-agenda" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <!-- O conte√∫do da agenda ser√° inserido aqui pelo JS -->
            </section>

            <!-- Configura√ß√µes -->
            <section id="view-config" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- O conte√∫do de configura√ß√µes ser√° inserido aqui pelo JS -->
            </section>
        </main>
    </div>

    <script>
        // --- SEU SCRIPT ORIGINAL ADAPTADO ---
        const $ = (sel, ctx = document) => ctx.querySelector(sel);
        const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

        const store = {
            get(k, d) { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
            set(k, v) { localStorage.setItem(k, JSON.stringify(v)) }
        }

        const state = {
            xp: store.get('xp', 0),
            streak: store.get('streak', 0),
            lastCheck: store.get('lastCheck', ''),
            level: 1,
            prefs: store.get('prefs', { wakeBy: '04:30', sleepAt: '21:30', xpPerLevel: 100, theme: 'dark', bus: false, weekend: 'livre' }),
            tasks: store.get('tasks', [
                { id: cid(), title: 'Beber √°gua ao acordar', cat: 'Manh√£', xp: 5 },
                { id: cid(), title: 'Banho + caf√© + roupa', cat: 'Manh√£', xp: 5 },
                { id: cid(), title: 'Alongar 5 minutos', cat: 'Manh√£', xp: 5 },
                { id: cid(), title: 'Podcast/Audiobook no trajeto', cat: 'Manh√£', xp: 5 },
                { id: cid(), title: 'Escrever 2 mat√©rias', cat: 'Trabalho', xp: 10 },
                { id: cid(), title: 'Redes (posts/Buffer)', cat: 'Trabalho', xp: 8 },
                { id: cid(), title: 'Edi√ß√£o (√°udio/v√≠deo)', cat: 'Trabalho', xp: 8 },
                { id: cid(), title: '3-min pausa para √°gua e respira√ß√£o', cat: 'Trabalho', xp: 4 },
                { id: cid(), title: 'Mini-ritual de chegada (15‚Ä≤)', cat: 'Casa', xp: 8 },
                { id: cid(), title: 'Cuidar da Eve 5‚Ä≤', cat: 'Casa', xp: 5 },
                { id: cid(), title: 'Arrumar 15‚Ä≤ com timer', cat: 'Casa', xp: 6 },
                { id: cid(), title: 'Preparar comida do dia seguinte', cat: 'Casa', xp: 8 },
                { id: cid(), title: 'Exerc√≠cio leve 20‚Äì30‚Ä≤', cat: 'Bem-estar', xp: 12 },
                { id: cid(), title: 'Jornal anti-autocr√≠tica', cat: 'Bem-estar', xp: 6 },
                { id: cid(), title: 'Croch√™/Pintura/Leitura 20‚Ä≤', cat: 'Criatividade', xp: 8 },
                { id: cid(), title: 'P√≥s EaD 20‚Äì30‚Ä≤ (ou revis√£o)', cat: 'P√≥s', xp: 10 },
            ]),
            doneToday: store.get('doneToday', {}),
            journal: store.get('journal', {}),
            weeklyGoals: store.get('weeklyGoals', []),
            doneWeekly: store.get('doneWeekly', {}),
            agendaEvents: store.get('agendaEvents', {}),
        }

        function cid() { return Math.random().toString(36).slice(2, 9) }

        function computeLevel() {
            const per = +state.prefs.xpPerLevel || 100;
            const oldLevel = state.level;
            state.level = Math.floor(state.xp / per) + 1;
            
            if (state.level > oldLevel) {
                const levelEl = $('#level');
                levelEl.parentElement.classList.add('level-up');
                setTimeout(() => levelEl.parentElement.classList.remove('level-up'), 1000);
            }

            const into = state.xp % per;
            const pct = Math.min(100, (into / per) * 100);
            
            const circumference = 2 * Math.PI * 40;
            const strokeDasharray = (pct / 100) * circumference;

            $('#level').textContent = state.level;
            $('#xp').textContent = `${state.xp} XP`;
            $('#bar').style.strokeDasharray = `${strokeDasharray} ${circumference}`;
        }

        function refreshHeader() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
            $('#greeting').textContent = date.charAt(0).toUpperCase() + date.slice(1);
        }

        $$('.tab').forEach(btn => btn.addEventListener('click', () => {
            $$('.tab').forEach(b => b.classList.remove('tab-active'));
            btn.classList.add('tab-active');
            const tab = btn.dataset.tab;
            $$('main > section').forEach(s => s.classList.add('hidden'));
            $(`#view-${tab}`).classList.remove('hidden');
        }));

        function section(container, filter) {
            container.innerHTML = '';
            const todayId = todayKey();
            const items = state.tasks.filter(t => filter(t)).map(t => {
                const el = document.createElement('div');
                el.className = 'task-item bg-white rounded-2xl p-3 shadow-sm';
                const done = !!(state.doneToday[todayId] && state.doneToday[todayId][t.id]);
                
                el.innerHTML = `
                    <label for="task-${t.id}" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="task-${t.id}" class="task-checkbox hidden" ${done ? 'checked' : ''}>
                        <div class="task-content flex items-center space-x-3 flex-1 transition-all duration-300">
                            <div class="task-icon w-10 h-10 rounded-xl flex items-center justify-center text-lg ${done ? 'bg-green-500 text-white' : 'bg-gray-100'}">
                                ${done ? '‚úÖ' : 'üìù'}
                            </div>
                            <div class="flex-1">
                                <p class="task-text font-medium text-gray-800">${t.title}</p>
                                <p class="text-xs text-gray-500">${t.cat} ¬∑ +${t.xp} XP</p>
                            </div>
                        </div>
                    </label>
                `;
                $('input', el).addEventListener('change', (e) => toggleDone(t, e.target.checked, el));
                return el;
            })
            if (items.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 p-4">Nenhuma tarefa aqui.</div>`;
            } else items.forEach(n => container.appendChild(n));
        }

        function buildUI() {
            section($('#morning'), t => t.cat === 'Manh√£');
            section($('#work'), t => t.cat === 'Trabalho');
            section($('#home'), t => ['Casa', 'Bem-estar', 'Criatividade', 'P√≥s'].includes(t.cat));
            buildConfig();
            buildWeek();
            buildAgenda();
            computeLevel();
            refreshHeader();
            updateStreak();
        }

        function todayKey() { const d = new Date(); return d.toISOString().slice(0, 10) }

        function toggleDone(task, checked, el) {
            const key = todayKey();
            state.doneToday[key] = state.doneToday[key] || {};
            const iconDiv = $('.task-icon', el);

            if (checked) {
                if (!state.doneToday[key][task.id]) { state.doneToday[key][task.id] = true; state.xp += task.xp; }
                iconDiv.innerHTML = '‚úÖ';
            } else {
                if (state.doneToday[key][task.id]) { delete state.doneToday[key][task.id]; state.xp = Math.max(0, state.xp - task.xp); }
                iconDiv.innerHTML = 'üìù';
            }
            persist();
            computeLevel();
            updateStreak();
        }

        function updateStreak() {
            const today = todayKey();
            if (state.lastCheck !== today) {
                const y = new Date(); y.setDate(y.getDate() - 1); const yKey = y.toISOString().slice(0, 10);
                const doneY = state.doneToday[yKey] && Object.keys(state.doneToday[yKey]).length > 0;
                const doneT = state.doneToday[today] && Object.keys(state.doneToday[today]).length > 0;
                if (doneT) { 
                    state.streak = doneY ? state.streak + 1 : 1; 
                    state.lastCheck = today; 
                } else if (!doneY) {
                    const y2 = new Date(); y2.setDate(y2.getDate() - 2); const y2Key = y2.toISOString().slice(0, 10);
                    if (!state.doneToday[y2Key] || Object.keys(state.doneToday[y2Key]).length === 0) {
                         state.streak = 0;
                    }
                }
                store.set('lastCheck', state.lastCheck);
            }
            $('#streak').textContent = state.streak;
        }

        function buildConfig() {
            const container = $('#view-config');
            container.innerHTML = `
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item">
                    <h3 class="font-bold text-indigo-800 mb-3">Adicionar Nova Tarefa Di√°ria</h3>
                    <div class="space-y-3">
                        <input id="newTitle" placeholder="Nome da tarefa" class="w-full p-2 border rounded-lg">
                        <select id="newCat" class="w-full p-2 border rounded-lg">
                            <option>Manh√£</option><option>Trabalho</option><option>Casa</option>
                            <option>Bem-estar</option><option>Criatividade</option><option>P√≥s</option>
                        </select>
                        <input id="newXP" type="number" value="5" placeholder="Pontos de XP" class="w-full p-2 border rounded-lg">
                        <button id="addTask" class="w-full bg-purple-500 text-white font-semibold py-2 rounded-lg hover:bg-purple-600 transition-colors">Adicionar Tarefa</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item">
                    <div id="taskList" class="space-y-3"></div>
                </div>
            `;
            
            const list = $('#taskList');
            list.innerHTML = `<h3 class="font-bold text-indigo-800 mb-3">Tarefas Atuais</h3>` + 
            state.tasks.map(t => `
                <div class="bg-white p-3 rounded-xl flex justify-between items-center text-sm">
                    <span>${t.title} <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${t.cat} / +${t.xp}XP</span></span>
                    <button data-del="${t.id}" class="text-red-500 hover:text-red-700 font-bold">‚úï</button>
                </div>
            `).join('');

            $$('[data-del]').forEach(btn => btn.addEventListener('click', () => removeTask(btn.dataset.del)));
            $('#addTask').addEventListener('click', () => {
                const title = $('#newTitle').value.trim(); if (!title) return;
                const cat = $('#newCat').value; const xp = parseInt($('#newXP').value || '5', 10);
                state.tasks.push({ id: cid(), title, cat, xp });
                persist(); buildUI();
            });
        }

        function removeTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            persist(); buildUI();
        }
        
        function buildWeek() {
            const container = $('#view-semana');
            container.innerHTML = `
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item">
                    <h3 class="font-bold text-indigo-800 mb-3">Prioridades Di√°rias</h3>
                    <div id="week-planner" class="space-y-3"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item">
                    <h3 class="font-bold text-indigo-800 mb-3">Metas Gerais da Semana</h3>
                    <div class="space-y-3 mb-3">
                        <input id="newWeeklyGoalTitle" placeholder="Ex: Fazer terapia" class="w-full p-2 border rounded-lg">
                        <button id="addWeeklyGoalBtn" class="w-full bg-purple-500 text-white font-semibold py-2 rounded-lg hover:bg-purple-600 transition-colors">Adicionar Meta</button>
                    </div>
                    <div id="weekly-goals-list" class="space-y-2"></div>
                </div>
            `;
            
            const planner = $('#week-planner');
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            planner.innerHTML = days.map(d => `
                <div class="flex items-center space-x-2">
                    <span class="font-semibold w-10">${d}:</span>
                    <input data-day="${d}" value="${store.get('prio-' + d, '') || ''}" placeholder="Prioridade do dia" class="flex-1 p-2 border rounded-lg text-sm">
                </div>
            `).join('');

            $$('#week-planner input').forEach(input => {
                input.addEventListener('change', (e) => {
                    store.set('prio-' + e.target.dataset.day, e.target.value);
                });
            });

            $('#addWeeklyGoalBtn').addEventListener('click', addWeeklyGoal);
            renderWeeklyGoals();
        }

        function addWeeklyGoal() {
            const titleInput = $('#newWeeklyGoalTitle');
            const title = titleInput.value.trim();
            if (!title) return;
            state.weeklyGoals.push({ id: cid(), title: title });
            titleInput.value = '';
            persist();
            renderWeeklyGoals();
        }

        function renderWeeklyGoals() {
            const listContainer = $('#weekly-goals-list');
            if (!listContainer) return;

            const weekKey = getWeekKey(new Date());

            if (!state.doneWeekly[weekKey]) {
                state.doneWeekly[weekKey] = {};
            }

            if (state.weeklyGoals.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 text-sm p-2">Nenhuma meta geral para a semana.</p>`;
                return;
            }

            listContainer.innerHTML = state.weeklyGoals.map(goal => {
                const isDone = !!state.doneWeekly[weekKey]?.[goal.id];
                return `
                    <div class="bg-gray-50 p-3 rounded-xl flex justify-between items-center text-sm">
                        <label for="wg-${goal.id}" class="flex items-center space-x-3 flex-1 cursor-pointer">
                            <input type="checkbox" id="wg-${goal.id}" data-wgid="${goal.id}" class="form-checkbox h-5 w-5 rounded text-purple-600 focus:ring-purple-500" ${isDone ? 'checked' : ''}>
                            <span class="${isDone ? 'line-through text-gray-400' : 'text-gray-800'}">${goal.title}</span>
                        </label>
                        <button data-del-wg="${goal.id}" class="text-red-500 hover:text-red-700 font-bold ml-4">‚úï</button>
                    </div>
                `;
            }).join('');

            $$('[data-wgid]').forEach(checkbox => checkbox.addEventListener('change', (e) => toggleWeeklyGoal(e.target.dataset.wgid, e.target.checked)));
            $$('[data-del-wg]').forEach(btn => btn.addEventListener('click', () => removeWeeklyGoal(btn.dataset.delWg)));
        }

        function getWeekKey(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date.getTime() - startOfYear.getTime()) / 86400000;
            return `${date.getFullYear()}-${Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7)}`;
        }

        function toggleWeeklyGoal(goalId, isChecked) {
            const weekKey = getWeekKey(new Date());

            if (!state.doneWeekly[weekKey]) {
                state.doneWeekly[weekKey] = {};
            }

            if (isChecked) {
                state.doneWeekly[weekKey][goalId] = true;
            } else {
                delete state.doneWeekly[weekKey][goalId];
            }
            persist();
            renderWeeklyGoals();
        }

        function removeWeeklyGoal(goalId) {
            state.weeklyGoals = state.weeklyGoals.filter(g => g.id !== goalId);
            persist();
            renderWeeklyGoals();
        }

        function buildAgenda() {
            const container = $('#view-agenda');
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            const hours = Array.from({ length: 18 }, (_, i) => `${(i + 6).toString().padStart(2, '0')}:00`); // 06:00 to 23:00

            container.innerHTML = `
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item lg:col-span-1">
                    <h3 class="font-bold text-indigo-800 mb-3">Adicionar Compromisso</h3>
                    <div class="space-y-3">
                        <input id="agendaEventTitle" placeholder="Nome do compromisso" class="w-full p-2 border rounded-lg">
                        <select id="agendaEventDay" class="w-full p-2 border rounded-lg">
                            ${days.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                        <input id="agendaEventTime" type="time" class="w-full p-2 border rounded-lg">
                        <button id="addAgendaEventBtn" class="w-full bg-purple-500 text-white font-semibold py-2 rounded-lg hover:bg-purple-600 transition-colors">Adicionar</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm config-item lg:col-span-2">
                    <h3 class="font-bold text-indigo-800 mb-3">Sua Semana</h3>
                    <div id="agenda-grid" class="overflow-x-auto"></div>
                </div>
            `;
            
            renderAgendaGrid();
            $('#addAgendaEventBtn').addEventListener('click', addAgendaEvent);
        }

        function renderAgendaGrid() {
            const gridContainer = $('#agenda-grid');
            if (!gridContainer) return;
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            const hours = Array.from({ length: 18 }, (_, i) => `${(i + 6).toString().padStart(2, '0')}:00`);

            let tableHTML = `<table class="w-full border-collapse text-xs text-center"><thead><tr><th class="w-12"></th>`;
            days.forEach(day => tableHTML += `<th class="p-1 border-b">${day}</th>`);
            tableHTML += `</tr></thead><tbody>`;

            hours.forEach(hour => {
                tableHTML += `<tr><td class="p-1 border-r font-semibold text-gray-500">${hour}</td>`;
                days.forEach(day => {
                    const eventKey = `${day}-${hour}`;
                    const event = state.agendaEvents[eventKey];
                    if (event) {
                        tableHTML += `<td class="p-1 border align-top relative agenda-event text-white rounded-md">
                            <div class="p-1">${event.title}</div>
                            <button data-del-event="${eventKey}" class="absolute top-0 right-0 text-white text-xs p-1">‚úï</button>
                        </td>`;
                    } else {
                        tableHTML += `<td class="p-1 border"></td>`;
                    }
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            gridContainer.innerHTML = tableHTML;
            
            $$('[data-del-event]').forEach(btn => btn.addEventListener('click', (e) => removeAgendaEvent(e.target.dataset.delEvent)));
        }

        function addAgendaEvent() {
            const title = $('#agendaEventTitle').value.trim();
            const day = $('#agendaEventDay').value;
            const time = $('#agendaEventTime').value;

            if (!title || !day || !time) {
                alert('Por favor, preencha todos os campos do compromisso.');
                return;
            }
            
            const hour = time.split(':')[0] + ':00';
            const eventKey = `${day}-${hour}`;

            state.agendaEvents[eventKey] = { id: cid(), title: title };
            persist();
            renderAgendaGrid();

            // Limpa os campos
            $('#agendaEventTitle').value = '';
            $('#agendaEventTime').value = '';
        }

        function removeAgendaEvent(eventKey) {
            delete state.agendaEvents[eventKey];
            persist();
            renderAgendaGrid();
        }

        function persist() {
            store.set('xp', state.xp);
            store.set('streak', state.streak);
            store.set('lastCheck', state.lastCheck);
            store.set('prefs', state.prefs);
            store.set('tasks', state.tasks);
            store.set('doneToday', state.doneToday);
            store.set('journal', state.journal);
            store.set('weeklyGoals', state.weeklyGoals);
            store.set('doneWeekly', state.doneWeekly);
            store.set('agendaEvents', state.agendaEvents);
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            buildUI();
        });

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registrado com sucesso:', registration.scope);
                }).catch(err => {
                    console.log('Falha no registro do ServiceWorker:', err);
                });
            });
        }
    </script>
</body>
</html>
