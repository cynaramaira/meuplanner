<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planner Gamificado ‚Ä¢ Rotina Compassiva</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#151923"/>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192x192.png">

  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --muted:#8a93a6; --text:#e8ecf3; --brand:#7aa2ff; --brand-2:#87f0c9; --danger:#ff7a7a; --ok:#9bff87;
      --ring: 24px; --rad: 16px; --gap: 14px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0e1016,#121622 60%,#0f1520);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;}
    .app{max-width:1100px;margin:24px auto;padding:0 16px 80px}
    header{
      display:grid;grid-template-columns:1fr auto;align-items:center;gap:var(--gap);
      background:linear-gradient(180deg,rgba(135,240,201,.10),rgba(122,162,255,.06));
      border:1px solid rgba(255,255,255,.06);border-radius:24px;padding:20px;box-shadow:var(--shadow);
    }
    .title{font-weight:700;font-size:22px;letter-spacing:.3px}
    .title small{display:block;color:var(--muted);font-weight:500;margin-top:4px}
    .kpis{display:flex;gap:14px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);padding:8px 12px;border-radius:999px}
    .chip b{font-variant-numeric:tabular-nums}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.06);position:relative;overflow:hidden}
    .progress>span{position:absolute;inset:0 0 0 auto;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0}
    nav{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
    .tab{border:none;background:rgba(255,255,255,.06);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s;}
    .tab[aria-selected="true"]{background:linear-gradient(90deg,rgba(122,162,255,.22),rgba(135,240,201,.22));}

    .grid{margin-top:18px;display:grid;gap:var(--gap);grid-template-columns:1.1fr .9fr}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--rad);box-shadow:var(--shadow)}
    .card h2{font-size:16px;margin:0;padding:16px 16px 0;color:#cbd6ff}
    .card .sub{color:var(--muted);font-size:13px;margin:6px 16px 0}
    .card .body{padding:14px 16px 16px}

    .task{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);margin-top:10px}
    .task input[type="checkbox"]{width:20px;height:20px}
    .task .meta{margin-left:auto;display:flex;gap:10px;color:var(--muted);font-size:12px}
    .task.done{opacity:.55; text-decoration:line-through}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row input,.row select,.row button,.row textarea{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--text)}
    .row button{cursor:pointer}
    .row .primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#0c1220;border:none}
    .row .danger{background:rgba(255,122,122,.15);border-color:rgba(255,122,122,.35)}

    .timer{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .timer .clock{font-size:40px;font-weight:700;letter-spacing:1px}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}

    .list{margin-top:8px}
    .list li{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px dashed rgba(255,255,255,.08);border-radius:10px;margin-top:8px}

    .footer-note{margin-top:14px;color:var(--muted);font-size:12px}

    .toggle{position:relative;width:48px;height:28px;border-radius:999px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);cursor:pointer}
    .toggle .dot{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;transition:.2s}
    .toggle[aria-checked="true"]{background:linear-gradient(90deg,var(--brand),var(--brand-2))}
    .toggle[aria-checked="true"] .dot{left:22px}

    .empty{opacity:.7;border:1px dashed rgba(255,255,255,.2);padding:18px;border-radius:12px;text-align:center}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div>
        <div class="title">Rotina Compassiva ‚Ä¢ Planner Gamificado
          <small id="greeting">‚Äì‚Äì</small>
        </div>
        <div class="kpis" role="group" aria-label="Indicadores">
          <div class="chip" title="N√≠vel baseado em XP"><span>üîÆ</span> N√≠vel <b id="level">1</b></div>
          <div class="chip" title="Experi√™ncia total"><span>‚ú®</span> XP <b id="xp">0</b></div>
          <div class="chip" title="Sequ√™ncia de dias conclu√≠dos"><span>üî•</span> Streak <b id="streak">0</b></div>
          <div class="chip" title="Hoje √© quarta? Terapia √†s 18h"><span>üß†</span> Terapia: <b id="therapy">‚Äì</b></div>
        </div>
        <div class="progress" aria-label="Progresso at√© o pr√≥ximo n√≠vel"><span id="bar"></span></div>
        <nav role="tablist" aria-label="Navega√ß√£o">
          <button class="tab" role="tab" aria-selected="true" data-tab="hoje">Hoje</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="semana">Semana</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="config">Configurar</button>
        </nav>
      </div>
      <div class="row" style="justify-content:flex-end;align-items:center">
        <label class="pill" title="Modo seguro para √¥nibus: foca em √°udio e leitura offline">
          üöç Modo √¥nibus
          <span id="busToggle" class="toggle" role="switch" aria-checked="false"><i class="dot"></i></span>
        </label>
        <label class="pill" title="Tema claro/escuro">
          üåì Tema
          <span id="themeToggle" class="toggle" role="switch" aria-checked="false"><i class="dot"></i></span>
        </label>
      </div>
    </header>

    <section id="view-hoje" class="grid" role="tabpanel" aria-labelledby="Hoje">
      <div class="card">
        <h2>Rituais da Manh√£</h2>
        <p class="sub">Acordar suave (04h00‚Äì04h30), √°gua na cabeceira, banho, caf√©, roupa, alongamento de 5‚Ä≤.</p>
        <div class="body" id="morning"></div>
      </div>

      <div class="card">
        <h2>Timer de Foco</h2>
        <p class="sub">Use blocos curtos (ex.: 25‚Ä≤ foco / 5‚Ä≤ pausa). Sem puni√ß√£o, s√≥ cuidado.</p>
        <div class="body">
          <div class="timer">
            <div class="clock" id="clock">25:00</div>
            <div class="row">
              <button class="primary" id="start">Iniciar</button>
              <button id="pause">Pausar</button>
              <button id="reset">Zerar</button>
              <select id="preset">
                <option value="25">25‚Ä≤ Foco</option>
                <option value="15">15‚Ä≤ Foco</option>
                <option value="5">5‚Ä≤ Respiro</option>
              </select>
            </div>
          </div>
          <p class="footer-note">Dica junguiana: comece pequeno, honrando o ritmo do corpo. Um bloco feito j√° conta.</p>
        </div>
      </div>

      <div class="card">
        <h2>Trabalho (07h‚Äì13h30)</h2>
        <p class="sub">Blocos: mat√©rias, redes, edi√ß√£o, pequenas pausas.</p>
        <div class="body" id="work"></div>
      </div>

      <div class="card">
        <h2>Chegada em Casa</h2>
        <p class="sub">Mini-ritual de 15‚Ä≤ + rota descanso ou pequena a√ß√£o.</p>
        <div class="body" id="home"></div>
      </div>

      <div class="card">
        <h2>Autoacolhimento</h2>
        <div class="body">
          <div class="row" style="width:100%">
            <textarea id="journal" rows="3" style="flex:1" placeholder="O que eu sustentei hoje?"></textarea>
            <button id="saveJournal" class="primary">Salvar</button>
          </div>
          <p class="footer-note">Pergunta anti-autocr√≠tica: ‚Äúo que eu j√° sustentei hoje?‚Äù</p>
        </div>
      </div>
    </section>

    <section id="view-semana" class="grid" style="display:none" role="tabpanel" aria-labelledby="Semana">
      <div class="card">
        <h2>Planejamento da Semana</h2>
        <p class="sub">Escolha 1 prioridade por dia. Fins de semana: alternar fam√≠lia / namorado.</p>
        <div class="body" id="week"></div>
      </div>
      <div class="card">
        <h2>Rotas de Fim de Semana</h2>
        <p class="sub">Defina o plano para este s√°bado e domingo.</p>
        <div class="body">
          <div class="row">
            <select id="weekendPlan">
              <option value="livre">Livre</option>
              <option value="familia">Viagem √† fam√≠lia (√¥nibus 15h ‚Ä¢ chegada ~19h ‚Ä¢ voltar s√°b noite ou dom manh√£)</option>
              <option value="namorado">Visita ao namorado (sa√≠da s√°bado tarde ‚Ä¢ volta domingo noite)</option>
            </select>
            <button id="saveWeekend" class="primary">Salvar</button>
          </div>
          <ul id="weekendList" class="list"></ul>
        </div>
      </div>
    </section>

    <section id="view-config" class="grid" style="display:none" role="tabpanel" aria-labelledby="Configurar">
      <div class="card">
        <h2>H√°bitos & Miss√µes (editar)</h2>
        <p class="sub">Adapte tarefas, pontos e categorias. Tudo fica salvo no seu navegador.</p>
        <div class="body">
          <div class="row">
            <input id="newTitle" placeholder="Nome da tarefa" />
            <select id="newCat">
              <option>Manh√£</option>
              <option>Trabalho</option>
              <option>Casa</option>
              <option>Bem-estar</option>
              <option>Criatividade</option>
              <option>P√≥s</option>
            </select>
            <input id="newXP" type="number" min="1" max="50" value="5" style="width:90px"/>
            <button id="addTask" class="primary">Adicionar</button>
          </div>
          <ul id="taskList" class="list"></ul>
        </div>
      </div>

      <div class="card">
        <h2>Prefer√™ncias</h2>
        <p class="sub">Personalize hor√°rios e metas gentis.</p>
        <div class="body">
          <div class="row">
            <label class="pill">‚è∞ Acordar at√© <input id="wakeBy" type="time" value="04:30"></label>
            <label class="pill">üí§ Dormir √†s <input id="sleepAt" type="time" value="21:30"></label>
            <label class="pill">üéØ XP por n√≠vel <input id="xpPerLevel" type="number" value="100" style="width:90px"></label>
            <button id="savePrefs" class="primary">Salvar prefer√™ncias</button>
          </div>
          <p class="footer-note">Sem rigidez: metas s√£o far√≥is, n√£o grades.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    const store = {
      get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    }

    const state = {
      xp: store.get('xp', 0),
      streak: store.get('streak', 0),
      lastCheck: store.get('lastCheck', ''),
      level: 1,
      prefs: store.get('prefs', { wakeBy:'04:30', sleepAt:'21:30', xpPerLevel:100, theme:'dark', bus:false, weekend:'livre' }),
      tasks: store.get('tasks', [
        {id:cid(), title:'Beber √°gua ao acordar', cat:'Manh√£', xp:5},
        {id:cid(), title:'Banho + caf√© + roupa', cat:'Manh√£', xp:5},
        {id:cid(), title:'Alongar 5 minutos', cat:'Manh√£', xp:5},
        {id:cid(), title:'Podcast/Audiobook no trajeto', cat:'Manh√£', xp:5},

        {id:cid(), title:'Escrever 2 mat√©rias', cat:'Trabalho', xp:10},
        {id:cid(), title:'Redes (posts/Buffer)', cat:'Trabalho', xp:8},
        {id:cid(), title:'Edi√ß√£o (√°udio/v√≠deo)', cat:'Trabalho', xp:8},
        {id:cid(), title:'3-min pausa para √°gua e respira√ß√£o', cat:'Trabalho', xp:4},

        {id:cid(), title:'Mini-ritual de chegada (15‚Ä≤)', cat:'Casa', xp:8},
        {id:cid(), title:'Cuidar da Eve 5‚Ä≤', cat:'Casa', xp:5},
        {id:cid(), title:'Arrumar 15‚Ä≤ com timer', cat:'Casa', xp:6},
        {id:cid(), title:'Preparar comida do dia seguinte', cat:'Casa', xp:8},

        {id:cid(), title:'Exerc√≠cio leve 20‚Äì30‚Ä≤', cat:'Bem-estar', xp:12},
        {id:cid(), title:'Jornal anti-autocr√≠tica', cat:'Bem-estar', xp:6},

        {id:cid(), title:'Croch√™/Pintura/Leitura 20‚Ä≤', cat:'Criatividade', xp:8},
        {id:cid(), title:'P√≥s EaD 20‚Äì30‚Ä≤ (ou revis√£o)', cat:'P√≥s', xp:10},
      ]),
      doneToday: store.get('doneToday', {}),
      journal: store.get('journal', {}),
    }

    function cid(){ return Math.random().toString(36).slice(2,9) }

    // Level calc
    function computeLevel(){
      const per = +state.prefs.xpPerLevel || 100; 
      state.level = Math.floor(state.xp / per) + 1;
      const into = state.xp % per;
      $('#level').textContent = state.level;
      $('#xp').textContent = state.xp;
      const pct = Math.min(100, (into / per) * 100);
      $('#bar').style.width = pct + '%';
    }

    // Greeting & therapy
    function refreshHeader(){
      const now = new Date();
      const wd = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][now.getDay()];
      const date = now.toLocaleDateString('pt-BR',{weekday:'long', day:'2-digit', month:'long'});
      $('#greeting').textContent = date.charAt(0).toUpperCase()+date.slice(1);
      $('#therapy').textContent = (now.getDay()===3? 'Hoje 18h':'N√£o hoje');
    }

    // Tabs
    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tab').forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      const tab = btn.dataset.tab;
      $('#view-hoje').style.display = tab==='hoje'? 'grid':'none';
      $('#view-semana').style.display = tab==='semana'? 'grid':'none';
      $('#view-config').style.display = tab==='config'? 'grid':'none';
    }))

    // Build sections
    function section(container, filter){
      container.innerHTML = '';
      const todayId = todayKey();
      const items = state.tasks.filter(t=>filter(t)).map(t=>{
        const el = document.createElement('div');
        el.className = 'task';
        const done = !!(state.doneToday[todayId] && state.doneToday[todayId][t.id]);
        if(done) el.classList.add('done');
        el.innerHTML = `
          <input type="checkbox" ${done?'checked':''} aria-label="Concluir ${t.title}">
          <div style="flex:1">
            <div style="font-weight:600">${t.title}</div>
            <div class="meta">${t.cat} ¬∑ <span>+${t.xp} XP</span></div>
          </div>
          <button aria-label="Remover tarefa" title="Remover" data-remove="${t.id}" class="row danger">‚úï</button>
        `;
        $('input', el).addEventListener('change', (e)=>toggleDone(t, e.target.checked, el));
        $('[data-remove]', el).addEventListener('click', ()=>removeTask(t.id));
        return el;
      })
      if(items.length===0){
        const empty = document.createElement('div'); empty.className='empty'; empty.textContent='Nenhuma tarefa aqui. Adicione em Configurar ‚Üí H√°bitos & Miss√µes.'; container.appendChild(empty)
      } else items.forEach(n=>container.appendChild(n));
    }

    function buildUI(){
      section($('#morning'), t=>t.cat==='Manh√£');
      section($('#work'), t=>t.cat==='Trabalho');
      section($('#home'), t=>['Casa','Bem-estar','Criatividade','P√≥s'].includes(t.cat));
      buildConfig();
      buildWeek();
      computeLevel();
      refreshHeader();
      updateToggles();
      updateStreak();
      renderWeekend();
    }

    // Done / XP / Streak
    function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10) }

    function toggleDone(task, checked, el){
      const key = todayKey();
      state.doneToday[key] = state.doneToday[key] || {};
      if(checked){
        if(!state.doneToday[key][task.id]){ state.doneToday[key][task.id]=true; state.xp += task.xp; toast(`+${task.xp} XP ‚Ä¢ ${task.title}`) }
        el.classList.add('done');
      } else {
        if(state.doneToday[key][task.id]){ delete state.doneToday[key][task.id]; state.xp = Math.max(0, state.xp - task.xp); toast(`‚àí${task.xp} XP ‚Ä¢ ${task.title}`) }
        el.classList.remove('done');
      }
      persist(); computeLevel(); updateStreak();
    }

    function updateStreak(){
      const today = todayKey();
      if(state.lastCheck !== today){
        // if yesterday had any done, maintain streak; else reset
        const y = new Date(); y.setDate(y.getDate()-1); const yKey = y.toISOString().slice(0,10);
        const doneY = state.doneToday[yKey] && Object.keys(state.doneToday[yKey]).length>0;
        const doneT = state.doneToday[today] && Object.keys(state.doneToday[today]).length>0;
        if(doneT){ state.streak = doneY? state.streak+1 : 1; state.lastCheck = today; }
        store.set('lastCheck', state.lastCheck);
      }
      $('#streak').textContent = state.streak;
    }

    // Config tasks
    function buildConfig(){
      const list = $('#taskList'); list.innerHTML='';
      state.tasks.forEach(t=>{
        const li=document.createElement('li');
        li.innerHTML=`<span style="display:flex;gap:10px;align-items:center"><b>${t.title}</b><small class="pill">${t.cat}</small><small class="pill">+${t.xp} XP</small></span>
        <span class="row"><button data-edit="${t.id}">Editar</button><button class="danger" data-del="${t.id}">Excluir</button></span>`;
        list.appendChild(li);
        $('[data-del]',li).addEventListener('click',()=>removeTask(t.id));
        $('[data-edit]',li).addEventListener('click',()=>editTask(t.id));
      })
      if(!state.tasks.length){ const li=document.createElement('li'); li.textContent='Sem tarefas. Adicione acima.'; list.appendChild(li) }
    }

    function removeTask(id){
      state.tasks = state.tasks.filter(t=>t.id!==id);
      persist(); buildUI();
    }

    function editTask(id){
      const t = state.tasks.find(x=>x.id===id); if(!t) return;
      const title = prompt('Novo t√≠tulo da tarefa:', t.title) ?? t.title;
      const cat = prompt('Categoria (Manh√£, Trabalho, Casa, Bem-estar, Criatividade, P√≥s):', t.cat) ?? t.cat;
      const xp = parseInt(prompt('XP (1-50):', t.xp) ?? t.xp, 10);
      t.title = title.trim()||t.title; t.cat=cat.trim()||t.cat; t.xp = isNaN(xp)? t.xp : Math.max(1, Math.min(50, xp));
      persist(); buildUI();
    }

    $('#addTask').addEventListener('click',()=>{
      const title = $('#newTitle').value.trim(); if(!title) return alert('D√™ um nome √† tarefa.');
      const cat = $('#newCat').value; const xp = Math.max(1, Math.min(50, parseInt($('#newXP').value||'5',10)));
      state.tasks.push({id:cid(), title, cat, xp});
      $('#newTitle').value=''; $('#newXP').value='5';
      persist(); buildUI();
    })

    // Preferences
    $('#savePrefs').addEventListener('click',()=>{
      state.prefs.wakeBy = $('#wakeBy').value || '04:30';
      state.prefs.sleepAt = $('#sleepAt').value || '21:30';
      state.prefs.xpPerLevel = Math.max(20, parseInt($('#xpPerLevel').value||'100',10));
      persist(); computeLevel(); toast('Prefer√™ncias salvas');
    })

    // Weekend planner
    function renderWeekend(){
      $('#weekendPlan').value = state.prefs.weekend || 'livre';
      const list = $('#weekendList'); list.innerHTML='';
      const plan = state.prefs.weekend;
      const items = {
        livre: ['Escolher 1 prioridade de bem-estar','Hobby criativo 20‚Ä≤','Arruma√ß√£o leve 15‚Ä≤'],
        familia: ['√înibus 15h ‚Ä¢ chegada ~19h','Alinhar volta com seu pai','Momentos com fam√≠lia sem culpa','Dormir bem para retorno'],
        namorado: ['Sa√≠da s√°bado √† tarde','Desconectar e curtir o encontro','Volta domingo √† noite','Preparar segunda (comida/roupa)']
      }[plan] || [];
      items.forEach(txt=>{ const li=document.createElement('li'); li.textContent=txt; list.appendChild(li) })
    }
    $('#saveWeekend').addEventListener('click',()=>{ state.prefs.weekend = $('#weekendPlan').value; persist(); renderWeekend(); toast('Fim de semana definido') })

    // Week grid quick plan
    function buildWeek(){
      const box = $('#week'); box.innerHTML='';
      const days = ['Seg','Ter','Qua','Qui','Sex','S√°b','Dom'];
      const wrap = document.createElement('div'); wrap.style.display='grid'; wrap.style.gap='12px'; wrap.style.gridTemplateColumns='repeat( auto-fit, minmax(220px,1fr) )';
      days.forEach(d=>{
        const c = document.createElement('div'); c.className='card'; c.innerHTML=`<h2>${d}</h2><div class="body">
          <input placeholder="Prioridade do dia" data-day="${d}" value="${store.get('prio-'+d,'')||''}" style="width:100%;margin-bottom:8px"/>
          <button data-save="${d}" class="primary">Salvar</button>
        </div>`; wrap.appendChild(c);
      })
      box.appendChild(wrap);
      $$('[data-save]', wrap).forEach(btn=>btn.addEventListener('click',()=>{
        const d = btn.getAttribute('data-save'); const v = $(`[data-day="${d}"]`, wrap).value; store.set('prio-'+d, v); toast('Prioridade salva para '+d)
      }))
    }

    // Journal
    $('#saveJournal').addEventListener('click',()=>{
      const key = todayKey(); state.journal[key] = $('#journal').value; persist(); toast('Anota√ß√£o salva')
    })

    // Timer
    let tLeft = 25*60, tId=null, running=false;
    function renderClock(){ const m=Math.floor(tLeft/60).toString().padStart(2,'0'); const s=(tLeft%60).toString().padStart(2,'0'); $('#clock').textContent = `${m}:${s}` }
    $('#preset').addEventListener('change', e=>{ tLeft = parseInt(e.target.value,10)*60; renderClock() })
    $('#start').addEventListener('click',()=>{ if(running) return; running=true; tId=setInterval(()=>{ tLeft--; renderClock(); if(tLeft<=0){ clearInterval(tId); running=false; toast('Tempo conclu√≠do. Fa√ßa uma pausa gentil.'); new Audio(beep()).play(); } },1000) })
    $('#pause').addEventListener('click',()=>{ running=false; clearInterval(tId) })
    $('#reset').addEventListener('click',()=>{ running=false; clearInterval(tId); tLeft = parseInt($('#preset').value,10)*60; renderClock() })
    function beep(){
      // tiny wav beep (data URI)
      return 'data:audio/wav;base64,UklGRp4AAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAEsAAACABYAAABiAAAAbwAAAF4AAABMAAAAbwAAAGIAAABXAAAARQAAAF4AAABkAAAASAAAAD4AAAAvAAAAJQAAACAAAABtZWFuYmVlcA=='
    }

    // Toggles theme & bus
    function updateToggles(){
      $('#themeToggle').setAttribute('aria-checked', state.prefs.theme==='light');
      $('#busToggle').setAttribute('aria-checked', !!state.prefs.bus);
      document.body.style.background = state.prefs.theme==='light'
        ? 'linear-gradient(120deg,#f7f9ff,#f1f5ff 60%,#eef3ff)'
        : 'linear-gradient(120deg,#0e1016,#121622 60%,#0f1520)';
    }
    $('#themeToggle').addEventListener('click',()=>{ state.prefs.theme = state.prefs.theme==='light'?'dark':'light'; persist(); updateToggles() })
    $('#busToggle').addEventListener('click',()=>{ state.prefs.bus = !state.prefs.bus; persist(); updateToggles(); toast(state.prefs.bus? 'Modo √¥nibus ativo (conte√∫dos de √°udio)': 'Modo √¥nibus desativado') })

    // Persist
    function persist(){
      store.set('xp', state.xp); store.set('streak', state.streak); store.set('lastCheck', state.lastCheck);
      store.set('prefs', state.prefs); store.set('tasks', state.tasks);
      store.set('doneToday', state.doneToday); store.set('journal', state.journal);
    }

    // Toast
    let toastId=null; function toast(msg){
      clearTimeout(toastId);
      let t = $('#toast'); if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t); Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'rgba(20,24,34,.95)',border:'1px solid rgba(255,255,255,.10)',padding:'10px 14px',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:99}) }
      t.textContent = msg; t.style.opacity='1'; toastId=setTimeout(()=>t.style.opacity='0',2000);
    }

    // Init
    (function(){
      $('#wakeBy').value = state.prefs.wakeBy; $('#sleepAt').value = state.prefs.sleepAt; $('#xpPerLevel').value = state.prefs.xpPerLevel;
      const j = state.journal[todayKey()]||''; $('#journal').value = j;
      buildUI(); renderClock();
    })()

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(registration => {
          console.log('ServiceWorker registrado com sucesso:', registration.scope);
        }).catch(err => {
          console.log('Falha no registro do ServiceWorker:', err);
        });
      });
    }
  </script>
</body>
</html>
